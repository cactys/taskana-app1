#!/usr/bin/env bash
set -xe

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è frontend –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –µ–≥–æ, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
if ! id "frontend" &>/dev/null; then
    echo "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å frontend –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞—é –µ–≥–æ..."
    # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è frontend –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –µ–≥–æ –≤ –≥—Ä—É–ø–ø—É www-data
    sudo useradd -M -G _nginx frontend
    echo "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å frontend —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≥—Ä—É–ø–ø—É www-data."
else
    echo "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å frontend —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."
fi

# –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
sudo rm -rf /var/www/taskana || true
sudo rm -r ~/taskana-app1.tar.gz || true

# –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞
if curl -u "${NEXUS_REPO_USER}:${NEXUS_REPO_PASS}" -o taskana-app1.tar.gz "${ARTIFACT_URL}"; then
    echo "‚úÖ –ê—Ä—Ç–µ—Ñ–∞–∫—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä"
else
    echo "‚ùå –§–∞—Ç–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä"
    exit 1
fi

# –†–∞–∑–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞
sudo mkdir -p /var/www/taskana || true
sudo tar -xzvf taskana-app1.tar.gz -C /var/www/taskana || true
echo "–ê—Ä—Ç–µ—Ñ–∞–∫—Ç —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω."

# –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∏ –≥—Ä—É–ø–ø—ã –¥–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
sudo chown frontend:_nginx -R /var/www/taskana || true
echo "–í–ª–∞–¥–µ–ª–µ—Ü –∏ –≥—Ä—É–ø–ø–∞ –¥–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ /var/www/taskana –∏–∑–º–µ–Ω–µ–Ω—ã –Ω–∞ frontend:_nginx."

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Nginx
sudo systemctl restart nginx.service
echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ."
echo "üîó –°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: https://taskana.khortys.ru"
